<%#- SPDX-License-Identifier: Apache-2.0 -%>
# This file is managed by Puppet!

[DEFAULT]
# Only in object-server must you use ipv6 without bracket.
bind_ip = [::]
bind_port = 8080
workers = <%= @num_workers %>
# bind_timeout = 30
# backlog = 4096
swift_dir = /etc/swift
user = swift

[pipeline:main]
pipeline = rewrite healthcheck cache tempurl tempauth cors staticweb proxy-logging proxy-server

[app:proxy-server]
use = egg:swift#proxy
# allow_account_management = true
account_autocreate = true

[filter:tempauth]
use = egg:swift#tempauth
token_life = 604800
<%- @user_accounts.each_pair do |user, password| -%>
<%- if user == 'admin' -%>
user_<%= user %>_<%= user %> = <%= password %> .admin .reseller_admin
<%- else -%>
user_<%= user %>_<%= user %> = <%= password %>
<%- end -%>
<%- end -%>

[filter:healthcheck]
use = egg:swift#healthcheck

[filter:cache]
use = egg:swift#memcache
memcache_servers = 127.0.0.1:11211
memcache_serialization_support = 2
# per worker!
memcache_max_connections = 12

[filter:ratelimit]
use = egg:swift#ratelimit
# accounts limited to 5/s PUT/DELETE to containers
account_ratelimit = 5
account_whitelist = AUTH_admin
log_sleep_time_seconds = 3
# containers with > 200 objects limited to 30/s PUT/DELETE/POST and listings
container_ratelimit_200 = 30
container_listing_ratelimit_200 = 30

[filter:tempurl]
use = egg:swift#tempurl
# default includes PUT
methods = GET HEAD

# s3api requirement
[filter:bulk]
use = egg:swift#bulk

[filter:container_sync]
use = egg:swift#container_sync

[filter:cors]
paste.filter_factory = miraheze.cors:filter_factory

[filter:proxy-logging]
use = egg:swift#proxy_logging
set access_log_facility = LOG_LOCAL1

[filter:rewrite]
# the auth system turns our login and key into an account / token pair.
# the account remains valid forever, but the token times out.
<%- @user_accounts.each_pair do |user, password| -%>
<%- if user == 'admin' -%>
account = AUTH_<%= user %>
<%- end -%>
<%- end -%>
# upload doesn't like our User-agent (Python-urllib/2.6), otherwise we could call it using urllib2.urlopen()
user_agent = Mozilla/5.0

# sending thumbnail requests to thumbor
thumbhost = static.miraheze.org

paste.filter_factory = miraheze.rewrite:filter_factory
