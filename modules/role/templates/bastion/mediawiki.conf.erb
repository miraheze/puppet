map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
}

<%- @backends.each_pair do | name, property | -%>
server {
	listen <%= property['port'] %> deferred backlog=16384 reuseport;
	listen [::]:<%= property['port'] %> deferred backlog=16384 reuseport;

	server_name localhost;

	access_log  off;

	location / {
        proxy_pass https://<%= name %>.miraheze.org;
		proxy_http_version 1.1;
		proxy_set_header Connection $connection_upgrade;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Host $host;
		# Don't clobber the Server header from the backend.
		proxy_pass_header Server;
		proxy_buffer_size       32k;
		proxy_buffers         4 32k;
		proxy_redirect off;
		proxy_buffering    off;
	}
}
<%- end -%>